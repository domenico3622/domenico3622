name: Slam Dunk Game logic

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  play-game:
    if: startsWith(github.event.issue.title, 'pass-ball')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Calculate Score & Update Image
        run: |
          # 1. Chiudiamo subito la Issue per pulizia
          gh issue close ${{ github.event.issue.number }} --comment "Nice pass! Sakuragi is moving!"
          
          # 2. Logica del Gioco (Script Bash semplice)
          # Contiamo quante volte Ã¨ stato eseguito il passaggio salvando un numero in un file
          if [ ! -f .github/assets/score.txt ]; then echo 0 > .github/assets/score.txt; fi
          SCORE=$(cat .github/assets/score.txt)
          SCORE=$((SCORE + 1))
          
          echo "Current Score: $SCORE"
          
          # 3. Aggiorniamo l'immagine in base al punteggio
          # Esempio: 0-10 click = Step 1, 11-20 click = Step 2, >20 = Dunk
          
          if [ $SCORE -lt 10 ]; then
             cp .github/assets/step1.png .github/assets/current.png
             echo "STATUS=DRIBBING" >> $GITHUB_ENV
          elif [ $SCORE -lt 20 ]; then
             cp .github/assets/step2.png .github/assets/current.png
             echo "STATUS=JUMPING" >> $GITHUB_ENV
          else
             cp .github/assets/step3.png .github/assets/current.png
             echo "STATUS=SLAM DUNK!" >> $GITHUB_ENV
             # Reset del punteggio dopo la schiacciata?
             if [ $SCORE -gt 25 ]; then echo 0 > .github/assets/score.txt; fi
          fi
          
          # Salviamo il nuovo punteggio
          echo $SCORE > .github/assets/score.txt

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit changes
        run: |
          git config --global user.name 'Sakuragi Bot'
          git config --global user.email 'bot@noreply.github.com'
          git add .github/assets/current.png .github/assets/score.txt
          git commit -m "Sakuragi Game Update: ${{ env.STATUS }}"
          git push
